name: Integration Tests

on:
  # Manual trigger with optional inputs
  workflow_dispatch:
    inputs:
      test_team_id:
        description: "Team ID to use for testing (optional)"
        required: false
        type: string
      test_dc_id:
        description: "Datacenter ID for test resources"
        required: false
        default: "1"
        type: string

  # Run on pull requests
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "src/codesphere/**"
      - "tests/integration/**"
      - ".github/workflows/integration.yml"

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.12"

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    # Only run if the secret is available (prevents failures on forks)
    if: ${{ github.repository == 'Datata1/codesphere-python' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv package manager
        uses: astral-sh/setup-uv@v6
        with:
          activate-environment: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run integration tests
        env:
          CS_TOKEN: ${{ secrets.CS_TOKEN }}
          CS_TEST_TEAM_ID: ${{ inputs.test_team_id || secrets.CS_TEST_TEAM_ID }}
          CS_TEST_DC_ID: ${{ inputs.test_dc_id || '1' }}
        run: |
          echo "Running integration tests..."
          uv run pytest tests/integration -v --run-integration \
            --junitxml=junit/integration-results.xml \
            --tb=short

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: junit/integration-results.xml
          retention-days: 30

      - name: Minimize uv cache
        run: uv cache prune --ci

  integration-tests-summary:
    name: Integration Tests Summary
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: integration-test-results
          path: junit

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: junit/integration-results.xml
          check_name: Integration Test Results
          comment_mode: off
